# ドキュメント（日本語版）

大磯屋さま向け口コミ生成・投稿ナビアプリ「review-gpt」の仕様・設計・運用手順をまとめたドキュメントです。  
アンケート回答 → Gemini API を使った口コミ生成 → Google マップ投稿導線までをスマートフォン完結で支援します。

---

## 1. プロジェクト概要
- 店頭やイベントで配布する QR コードやURLからアンケートフォームへ誘導し、回答完了と同時に AI 生成ページへ進める。
- 回答完了後に AI が生成したサンプル口コミを提示し、そのまま Google マップ等の外部プラットフォームへ遷移できる導線を確保する。
- 管理画面からルータ設定・アンケート設問・生成プロンプト・ユーザープロファイルを編集し、Netlify Blobs に保存することでノーコード運用を実現する。
- API キーや GAS URL などの秘匿値は管理画面でのみ閲覧・登録させ、運用担当と開発者の権限分離を容易にする。

---

## 2. ユースケースと主要画面フロー
### フォームフロー
- `/`（アンケート1）: アクセス直後にフォームを表示。回答完了で AI 生成ページへ遷移。
- `form1`〜`form3`: 管理画面の設問設定（タイプ、必須、複数回答可、星評価 ON/OFF、プレースホルダー、口コミ反映フラグ）を読み込み動的に表示。送信時は設定済み API へ POST し、成功後に対応する生成ページへ遷移。

### 口コミ生成ページ `/generator/page1`
- フォーム送信後に `/.netlify/functions/generate` を呼び出し、GAS 経由で取得した回答データ＋保存済みプロンプトを Gemini API（v1）へ連携。
- 生成された口コミをカード表示し、ワンタップでコピーまたは Google マップ投稿に移動できる UI を提供。

### 管理画面 `/admin`
- **ルータ設定**: カード文言／ボタン色／遷移先 URL／配信順序を編集し、イベントや出店場所に応じて即座にチューニング。
- **システム設定**: Gemini モデルと API キー、GAS URL、アンケート送信先 API/キー、Blobs へ保存する認証情報を管理。秘匿値はマスク表示。
- **アクセスガイド**: `/user` 画面や運用フローへの導線をまとめ、現場共有用に利用。
### ユーザー設定 `/user`
- **管理者設定タブ**で運用担当者の連絡先とパスワードのみを管理し、店舗固有情報の入力は不要。
- **ロゴ設定タブ**でロゴ画像をアップロードすると、ルータ・各アンケート・生成ページのヘッダーに反映され、未設定時は従来のテキストロゴを表示。
- 運用担当が頻繁に編集する要素（アンケート設定、AI プロンプト、ブランド画像など）を 1 画面に集約し、システム寄りの情報は `/admin` に隔離。

---

## 3. アーキテクチャとデータフロー
### フロントエンド
- Vite + React（TypeScript）で構築し、Netlify へデプロイ。
- `src` はルータ／管理画面／ユーザー設定／各フォーム／各生成ページをページ単位で分割。デザインは Noto Sans / Zen Maru Gothic を採用し、ピンク〜サーモン系グラデーションと 3 カップのブランドカラーを統一。

### 永続化と API
- 設定値・ユーザープロファイルは Netlify Blobs に JSON で保存。暗号化は行わないため、Netlify 側のサイト権限でアクセスを制限する運用が前提。
- フォーム回答は管理画面で登録した任意の Web API や GAS へ送信し、`formKey` と回答内容、メタ情報を含めて POST。保存先未設定の場合はローカル保持で完了させる。

### Netlify Functions
- `config` (`netlify/functions/config.js`): 管理画面から送信される各種設定（ルータ、アンケート、プロンプト、ユーザープロファイル、GAS URL など）を CRUD。
- `generate`: GAS で取得した回答データ＋保存済みプロンプトを Gemini API に渡し、生成文を返す。
- `survey-submit`: フォーム回答を指定エンドポイントへ送信するバックエンド。API キーや GAS URL を読み込みつつログを付与。
- `user-data-submit`: `/user` で入力された管理者連絡先などを GAS に橋渡しするためのプロキシ。
- `upload`: Blobs 動作確認用のスタブ。

---

## 4. 設定項目とデータ構造
### エントリ & ランディング
- `/` ではアンケート1フォームを直接表示し、タイトルやリード文、質問構成は管理画面から即時反映できる。
- `/admin` で保存後すぐにフロントへ反映されるため、デプロイなしで現場調整が可能。

### アンケートフォーム定義
- `form1`: 星評価＋自由記述を中心に、管理画面で定義した設問を表示。`rating` / `text` / `dropdown` / `checkbox` が利用でき、`allowMultiple` や `includeInReview` も制御可能。
- 各質問は `id` / `title` / `required` / `type` / `options` / `ratingStyle` / `includeInReview` を持ち、保存時にサニタイズされる。

### プロンプト＆ Gemini 設定
- 管理画面の「システム設定」タブで、Gemini API キーや各ページ用プロンプト文字列、参照URLを登録し運用担当が調整できる。
- `generate` 関数は `data-prompt-key` で呼び出すプロンプトを切り替え、フォーム別のトーンを維持。

### ユーザープロファイル & 運用情報
- 店舗名・業種・客層・強み・駅近フラグ・キーワード群・除外ワード群・管理者アカウント情報を保存。生成文への差し込みや検索露出対策に活用。
- Google マップ口コミリンクを保持しておくことで、生成ページから同リンクへ遷移する際に流用。

### 外部送信設定
- アンケートの保存先として、Spreadsheet URL / 任意 API エンドポイント / API キーを登録可能。
- GAS 連携用に `submitGasUrl` / `readGasUrl` を保持し、回答データの取得や再生成に利用。

---

## 5. 開発・運用フロー
### ローカル開発
1. `npm install`
2. `npm run dev`（Vite 開発サーバ）
### ビルド & デプロイ
1. `npm run build` で `dist/` を生成。
2. `netlify deploy --prod --dir=dist` で本番更新。
3. デプロイ後、必要に応じて共有用のURLやQRコードを別途更新。
4. Netlify 環境変数に `NETLIFY_SITE_ID` と `NETLIFY_BLOBS_TOKEN`（または `NETLIFY_AUTH_TOKEN`）を登録。Gemini API キーや GAS URL は管理画面から登録する。

### 推奨テスト
- フォーム → 生成ページの一連の導線をスマートフォン実機で確認し、Gemini API のレスポンス／投稿導線をチェック。
- 管理画面で各タブの保存 → 反映 → フォーム UI への影響を確認。
- Netlify Functions を `netlify dev` で起動し、`config` / `generate` / `survey-submit` が 200 を返すか確認。

---

## 6. 今後の検討事項
- アンケート回答内容の永続化と全文検索（例: Supabase, S3, Firestore 連携）。
- 口コミ生成プロンプトの A/B テストや自動チューニング（Feedback ループの導入）。
- フォーム回答と投稿状況を集約するダッシュボードやレポート機能。
- Playwright 等を用いた管理画面・フォーム・生成ページの自動回帰テスト整備。
